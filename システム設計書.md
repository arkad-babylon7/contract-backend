# 契約書管理プラットフォーム_要件定義書

## サービス概要
- **目的**: ユーザーが契約書を効率的かつ柔軟に作成、編集、管理できるプラットフォームを提供。
- **問題解決**: 従来の契約書作成プロセスのフォーマット制約、編集の不便さ、法的確認の手間を解消。

## ターゲットユーザー
- **主要対象**: 中小企業、フリーランサー、スタートアップ企業。
- **ユーザー要求**: 契約書の柔軟性、効率性、法的安全性。非専門家でも簡単に利用可能。

## 主要機能
1. **契約書編集ツール**
   - 契約書の条項を簡単に追加、削除、再配置できるインターフェース。
2. **柔軟なカスタマイズ**
   - 利害関係者の優劣を調整可能。
3. **電子署名と契約締結**
   - サービス内で完結する電子署名機能。
4. **保存・管理・ダウンロード機能**
   - 契約書のオンラインでの保存と管理、ダウンロード機能。
5. **AIによるリーガルチェック**
   - 契約書が法的に適切か自動でチェックする機能。
6. **行政書士によるサポート**
   - 書類作成支援や法的チェックを行う専門家サービス。

## 技術スタック
- **フロントエンド**: Next.js
- **バックエンド**: Laravel、FastAPI
- **データベース**: MySQL
- **インフラ**: AWS
- **コード管理**: GitHub

## 開発フェーズ
1. **初期バージョン (6ヶ月～1年)**
   - 基本的な契約書編集機能、電子署名、保存機能、最低限のAIチェック。

# システム設計書
## アーキテクチャ概要
### 1. システムアーキテクチャ
- **フロントエンド**: 
  - ユーザーインターフェースはNext.jsを使用してSPA（シングルページアプリケーション）として構築。リアクティブなユーザー体験を提供し、APIを介してバックエンドと通信します。
- **バックエンド**: 
  - LaravelとFastAPIを併用。Laravelは主に管理機能と認証、基本的なCRUD操作に使用。FastAPIは高速なAPI要求に対応し、特にリアルタイムデータ処理とAI機能を担当。
- **データベース**: 
  - MySQLを主データストアとして使用し、契約書テンプレート、ユーザーデータ、トランザクションログなどの管理を行います。
- **外部サービス**: 
  - 電子署名、リーガルチェックなどの機能を提供するために、外部APIとの統合が必要。
### 2. インフラストラクチャ
- **AWSを基盤として使用**:
  - **EC2**: サーバーインスタンスとして使用し、アプリケーションサーバーをホスト。
  - **RDS**: MySQLデータベース管理。
  - **S3**: 契約書ドキュメントの保存およびバックアップ用。
  - **Elastic Load Balancing**: 負荷分散を行い、システムの可用性と耐障害性を向上。
  - **CloudFront**: コンテンツ配信ネットワーク（CDN）として利用し、静的リソースとキャッシュ可能なコンテンツの配信を高速化。
  - **Route 53**: DNS管理。
### 3. セキュリティ構成
- **認証**: 
  - JWT（JSON Web Tokens）を用いたステートレス認証システム。
- **データ暗号化**: 
  - データベース内の機密データはAES暗号化を用いて保護。
- **ネットワークセキュリティ**: 
  - VPC内にリソースを配置し、セキュリティグループとネットワークACLでアクセス制御。
### 4. バックアップとリカバリ
- **データベースバックアップ**: 
  - RDSの自動バックアップ機能を利用。
- **アプリケーションデータ**: 
  - S3に周期的にバックアップ。

# テーブル設計

## ユーザーテーブル（users）
| カラム名    | 型           | 説明                 |
|-------------|--------------|----------------------|
| id          | UUID         | ユーザーの一意識別子 |
| name        | VARCHAR(255) | ユーザー名           |
| email       | VARCHAR(255) | メールアドレス（ユニーク） |
| password    | VARCHAR(255) | ハッシュ化されたパスワード |
| role        | ENUM('admin', 'user', 'lawyer') | ユーザーの権限 |
| created_at  | TIMESTAMP    | 作成日時             |
| updated_at  | TIMESTAMP    | 更新日時             |

## 契約書テーブル（contracts）
| カラム名     | 型           | 説明                 |
|--------------|--------------|----------------------|
| id           | UUID         | 契約書の一意識別子   |
| title        | VARCHAR(255) | 契約書のタイトル     |
| status       | ENUM('draft', 'signed', 'pending_review', 'archived') | 契約書の状態 |
| created_by   | UUID         | 作成者（users.id）   |
| signed_at    | TIMESTAMP NULL | 契約締結日時       |
| reviewed_by  | UUID NULL    | 行政書士によるレビュー担当者（users.id） |
| created_at   | TIMESTAMP    | 作成日時             |
| updated_at   | TIMESTAMP    | 更新日時             |

## ブロックライブラリ（blocks）
| カラム名     | 型           | 説明                 |
|--------------|--------------|----------------------|
| id           | UUID         | ブロックの一意識別子 |
| title        | VARCHAR(255) | ブロックの名称       |
| type         | ENUM('text', 'clause', 'variable', 'image') | ブロックの種類 |
| content      | TEXT         | デフォルトのコンテンツ（JSONで保存可能） |
| category     | VARCHAR(255) | カテゴリ（例: 契約条項, 署名欄, 見出し） |
| created_by   | UUID         | 作成者（users.id）   |
| created_at   | TIMESTAMP    | 作成日時             |
| updated_at   | TIMESTAMP    | 更新日時             |

## 契約書ごとのブロック配置（contract_blocks）
| カラム名     | 型           | 説明                 |
|--------------|--------------|----------------------|
| id           | UUID         | レコードの一意識別子 |
| contract_id  | UUID         | 契約書ID（contracts.id） |
| block_id     | UUID         | ブロックID（blocks.id） |
| position     | INT          | ブロックの順番       |
| custom_content | TEXT       | ユーザーが編集した内容（NULLならデフォルト使用） |
| created_at   | TIMESTAMP    | 作成日時             |
| updated_at   | TIMESTAMP    | 更新日時             |

## ブロックのバージョン管理（block_versions）
| カラム名     | 型           | 説明                 |
|--------------|--------------|----------------------|
| id           | UUID         | バージョンの一意識別子 |
| block_id     | UUID         | ブロックID（blocks.id） |
| version      | INT          | バージョン番号       |
| content      | TEXT         | 変更時のブロック内容 |
| updated_by   | UUID         | 更新者（users.id）   |
| updated_at   | TIMESTAMP    | 更新日時             |

## 変数データ（block_variables）
| カラム名     | 型           | 説明                 |
|--------------|--------------|----------------------|
| id           | UUID         | 変数の一意識別子     |
| block_id     | UUID         | ブロックID（blocks.id） |
| variable_name | VARCHAR(255)| 変数名（例: {contractor_name}） |
| default_value | VARCHAR(255)| デフォルト値         |
| created_at   | TIMESTAMP    | 作成日時             |
| updated_at   | TIMESTAMP    | 更新日時             |

## 契約書ごとの変数適用（contract_block_variables）
| カラム名     | 型           | 説明                 |
|--------------|--------------|----------------------|
| id           | UUID         | レコードの一意識別子 |
| contract_id  | UUID         | 契約書ID（contracts.id） |
| block_id     | UUID         | ブロックID（blocks.id） |
| variable_name| VARCHAR(255) | 変数名               |
| value        | VARCHAR(255) | 実際に使用する値     |
| created_at   | TIMESTAMP    | 作成日時             |
| updated_at   | TIMESTAMP    | 更新日時             |

# 関係性と想定する動作

## 関係性
- `users` は `contracts` を作成する。
- `contracts` は `contract_blocks` を通じて `blocks` を追加。
- `contract_blocks` により、契約書ごとにブロックの順序や内容をカスタマイズ。
- `block_versions` により、ブロックの過去バージョンを管理。
- `block_variables` により、動的な変数を設定。
- `contract_block_variables` により、契約書ごとに変数を適用。

## 想定する動作
### 契約書を作成する
- `blocks`（ブロックライブラリ）からブロックを選択し、`contract_blocks` に追加。
- ドラッグ＆ドロップで順序を変更。
- 追加したブロックの内容を個別に編集可能。

### ブロックの内容をカスタマイズ
- 変数 `{contractor_name}` を契約書ごとに適用 (`contract_block_variables`)。

### ブロックのバージョンアップ
- `blocks` を更新。
- 影響を受ける契約書を通知。
- 契約書ごとに更新するか選択可能。

## UIのイメージ
- **左側**: ブロックライブラリ（標準の契約条項やテンプレート）
- **中央**: エディター（ドラッグ＆ドロップでブロックを配置）
- **右側**: ブロックの詳細設定（変数のカスタマイズ、順序変更）
